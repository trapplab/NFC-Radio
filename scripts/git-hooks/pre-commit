#!/usr/bin/env bash

# Check version consistency between pubspec.yaml and Changelog.md
git diff --cached --name-only | grep -qE "(pubspec\.yaml|Changelog.md)" && {
  echo "üîç Checking version consistency..."
  
  # Extract version from pubspec.yaml (remove build number if present)
  PUBSPEC_VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//' | tr -d ' ')
  
  # Check if Changelog.md has a version header that matches
  CHANGELOG_VERSION=$(grep -E "^## \[" Changelog.md | head -1 | sed 's/## \[//' | sed 's/\]//' | tr -d ' ')
  
  if [ "$PUBSPEC_VERSION" != "$CHANGELOG_VERSION" ]; then
    echo "‚ùå Version mismatch detected!"
    echo "   pubspec.yaml version: $PUBSPEC_VERSION"
    echo "   Changelog.md version: $CHANGELOG_VERSION"
    echo ""
    echo "Please ensure both files have the same version number."
    exit 1
  fi
  
  echo "‚úÖ Version consistency check passed ($PUBSPEC_VERSION)"
}

# Check version consistency between pubspec.yaml, pubspec.play.yaml, and pubspec.fdroid.yaml
git diff --cached --name-only | grep -qE "pubspec" && {
  echo "üîç Checking pubspec version consistency..."

  # Extract version from pubspec.play.yaml (master version)
  PLAY_VERSION=$(grep "^version:" pubspec.play.yaml | sed 's/version: //' | tr -d ' ')

  # Extract version from pubspec.yaml
  YAML_VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | tr -d ' ')

  # Extract version from pubspec.fdroid.yaml
  FDROID_VERSION=$(grep "^version:" pubspec.fdroid.yaml | sed 's/version: //' | tr -d ' ')

  if [ "$PLAY_VERSION" != "$YAML_VERSION" ] || [ "$PLAY_VERSION" != "$FDROID_VERSION" ]; then
    echo "‚ùå Version mismatch detected in pubspec files!"
    echo "   pubspec.play.yaml version: $PLAY_VERSION"
    echo "   pubspec.yaml version: $YAML_VERSION"
    echo "   pubspec.fdroid.yaml version: $FDROID_VERSION"
    echo ""
    echo "Please ensure all pubspec files have the same version."
    exit 1
  fi

  echo "‚úÖ Pubspec version consistency check passed ($PLAY_VERSION)"
}

# Check if Changelog.md is staged
if git diff --cached --name-only | grep -q "Changelog.md"; then
  # Extract the latest version from Changelog.md
  LATEST_VERSION=$(grep -m 1 "## \[" Changelog.md | sed 's/## \[\(.*\)\]/\1/')
  
  # Convert semantic version to version code
  IFS='.' read -ra VERSION_PARTS <<< "$LATEST_VERSION"
  MAJOR=${VERSION_PARTS[0]}
  MINOR=${VERSION_PARTS[1]}
  PATCH=${VERSION_PARTS[2]}
  VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
  
  # Check if changelog files already exist
  CHANGELOG_FILE="fastlane/metadata/android/en-US/changelogs/$VERSION_CODE.txt"
  
  if [ -f "$CHANGELOG_FILE" ]; then
    echo "‚ÑπÔ∏è  Changelog files for version $LATEST_VERSION already exist."
  else
    echo "Changelog.md was modified. Generating changelog files..."
    
    # Extract the changelog entry for the latest version
    CHANGELOG_ENTRY=$(sed -n "/## \[$LATEST_VERSION\]/,/## \[/p" Changelog.md | sed '1d;$d' | sed 's/^### /## /')
    
    # Use the translation script to update changelogs
    ./update_changelogs_with_translation.sh "$LATEST_VERSION" "$CHANGELOG_ENTRY"
    
    echo ""
    echo "‚úÖ Changelog files generated. Aborting commit so you can stage all files together."
    echo "   Run 'git add fastlane/metadata/android/*/changelogs/*.txt' and commit again."
    echo ""
    exit 1
  fi
fi
